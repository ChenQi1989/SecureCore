source poky/oe-init-build-env build-secure-core

S="${BASH_SOURCE[0]}"
D=`dirname "$S"`
SECURE_CORE_ROOT="`cd "$D"/.. && pwd`"

cat <<EOF>>conf/local.conf

# SecureCore-specific settings
MACHINE_forcevariable = "qemux86-64"

INITRAMFS_IMAGE = "secure-core-image-initramfs"

VIRTUAL-RUNTIME_init_manager = "systemd"

DISTRO_FEATURES_NATIVE_append += "systemd ima tpm tpm2 efi-secure-boot luks"
DISTRO_FEATURES_append += "systemd ima tpm tpm2 efi-secure-boot luks"

MACHINE_FEATURES_NATIVE_append += "efi"
MACHINE_FEATURES_append += "efi"

SECURE_CORE_IMAGE_EXTRA_INSTALL_append += "\
"

RPM_GPG_NAME ??= ""
RPM_GPG_PASSPHRASE ??= ""

DEBUG_FLAGS_forcevariable = ""

EOF

if [ -s "$SECURE_CORE_ROOT/extra-init-build-env" ]; then
    cat "$SECURE_CORE_ROOT/extra-init-build-env" >> conf/local.conf
fi

bitbake-layers add-layer ../meta-openembedded/meta-oe
bitbake-layers add-layer ../meta-openembedded/meta-perl
bitbake-layers add-layer ../meta-secure-core/meta
bitbake-layers add-layer ../meta-secure-core/meta-signing-key
bitbake-layers add-layer ../meta-secure-core/meta-tpm
bitbake-layers add-layer ../meta-secure-core/meta-tpm2
bitbake-layers add-layer ../meta-secure-core/meta-efi-secure-boot
bitbake-layers add-layer ../meta-secure-core/meta-integrity
bitbake-layers add-layer ../meta-secure-core/meta-encrypted-storage

cat <<EOF>>conf/local.conf

INHERIT += "sign_rpm_ext"

EOF

touch .configured
